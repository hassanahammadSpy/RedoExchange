<!-- START OF FILE IndexUser.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RedExChangerBot</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Monetag SDK Script (Updated with your ID) -->
    <script src='//libtl.com/sdk.js' data-zone='10481635' data-sdk='show_10481635'></script>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        /* CSS Variables for Themes */
        :root { 
            --primary: #ff2b2b; 
            --gradient: linear-gradient(135deg, #ff2b2b 0%, #d50000 100%); 
            --verified: #1da1f2;
        }

        /* Dark Mode Colors */
        body.dark-mode {
            --bg: #0f0f0f; 
            --card: #1e1e1e; 
            --text: #ffffff; 
            --text-sec: #aaaaaa; 
            --border: #333333; 
            --input-bg: #2b2b2b; 
            --shadow: 0 4px 15px rgba(0,0,0,0.3);
            --capsule-bg: rgba(255, 255, 255, 0.1);
            --sheet-bg: #1e1e1e;
        }

        /* Light Mode Colors */
        body.light-mode {
            --bg: #f4f6f8; 
            --card: #ffffff; 
            --text: #1a1a1a; 
            --text-sec: #555555; 
            --border: #e0e0e0; 
            --input-bg: #f0f2f5; 
            --shadow: 0 2px 10px rgba(0,0,0,0.05);
            --capsule-bg: rgba(0, 0, 0, 0.05);
            --sheet-bg: #ffffff;
        }

        body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding-bottom: 90px; -webkit-font-smoothing: antialiased; transition: background 0.3s, color 0.3s; }
        
        #loadingScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .pulse-logo { width: 100px; animation: breathe 2s infinite; border-radius: 20px; }
        @keyframes breathe { 0% { transform: scale(0.9); opacity: 0.7; } 50% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(0.9); opacity: 0.7; } }
        
        /* General Popup */
        .popup { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:3000; display:none; justify-content:center; align-items:center; backdrop-filter: blur(3px); }
        .popup-content { background: var(--card); padding: 25px 25px; width: 85%; max-width: 320px; border-radius: 20px; text-align: center; position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: popUpAnim 0.3s; border: 1px solid var(--border); }
        @keyframes popUpAnim { from{transform: scale(0.9); opacity: 0;} to{transform: scale(1); opacity: 1;} }
        
        .header { background: var(--card); padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 50; border-radius: 0 0 25px 25px; border-bottom: 1px solid var(--border); }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        .user-details { display: flex; flex-direction: column; gap: 4px; }
        .user-name { font-weight: 700; font-size: 15px; margin: 0; display: flex; align-items: center; gap: 6px; }
        .verified-badge { color: #fff; background: var(--verified); border-radius: 50%; padding: 2px; font-size: 10px; width: 14px; height: 14px; display: inline-flex; align-items: center; justify-content: center; }
        .balance-capsule { display: inline-flex; align-items: center; background: var(--capsule-bg); padding: 2px 10px; border-radius: 50px; font-size: 12px; font-weight: 700; color: var(--primary); width: fit-content; border: 1px solid rgba(255,43,43,0.2); }
        
        .wallet-custom-btn { background: #d50000; color: white; padding: 8px 15px; border-radius: 50px; display: flex; align-items: center; gap: 8px; font-weight: bold; font-size: 14px; cursor: pointer; box-shadow: 0 4px 12px rgba(213, 0, 0, 0.4); border: 1px solid #ff2b2b; transition: 0.2s; }
        .wallet-custom-btn:active { transform: scale(0.95); }

        .section { display: none; padding: 20px; animation: fadeIn 0.4s ease-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
        
        .card { background: var(--card); padding: 20px; border-radius: 20px; margin-bottom: 15px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .btn { width: 100%; padding: 14px; background: var(--gradient); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 15px; margin-top: 10px; box-shadow: 0 4px 10px rgba(255, 43, 43, 0.3); transition: transform 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn.disabled { background: #666; color: #ccc; box-shadow: none; pointer-events: none; }

        .form-control { width: 100%; padding: 14px; background: var(--input-bg); border: 1px solid var(--border); color: var(--text); border-radius: 12px; margin-bottom: 12px; box-sizing: border-box; outline: none; transition: border 0.3s; }
        .form-control:focus { border-color: var(--primary); }
        
        .select-trigger { width: 100%; padding: 14px; background: var(--input-bg); border: 1px solid var(--border); color: var(--text-sec); border-radius: 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; box-sizing: border-box; transition: 0.2s; }
        .select-trigger:active { background: var(--capsule-bg); }
        .select-trigger.selected { color: var(--text); font-weight: 600; border-color: var(--primary); }
        
        .nav { position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; justify-content: space-around; padding: 15px 0 10px 0; border-top: 1px solid var(--border); z-index: 100; border-radius: 25px 25px 0 0; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); }
        .nav-item { text-align: center; color: var(--text-sec); font-size: 11px; width: 60px; transition: 0.3s; }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }
        .nav-item i { font-size: 20px; margin-bottom: 4px; display: block; }
        .close-pop { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: var(--text-sec); }
        
        .banner-container { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; gap: 15px; padding-bottom: 10px; } .banner-container::-webkit-scrollbar { display: none; } 
        .banner-slide { min-width: 100%; scroll-snap-align: center; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; } 
        .banner-slide img { width: 100%; display: block; }
        .banner-btn { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 15px; border-radius: 5px; font-size: 12px; font-weight: bold; border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(2px); cursor: pointer; }

        /* OFFER BTN CHANGED TO RED */
        .offer-btn { background: #ff2b2b; color: white; border: none; padding: 8px 24px; border-radius: 50px; font-weight: 600; font-size: 13px; text-decoration: none; display: inline-block; margin-top: 8px; box-shadow: 0 4px 10px rgba(255, 43, 43, 0.3); }
        
        /* BOTTOM SHEETS & ANIMATION */
        .bottom-sheet { position: fixed; bottom: -100%; left: 0; width: 100%; background: var(--sheet-bg); border-radius: 25px 25px 0 0; z-index: 2000; transition: bottom 0.4s cubic-bezier(0.33, 1, 0.68, 1); padding: 0; box-sizing: border-box; border-top: 1px solid var(--border); box-shadow: 0 -10px 30px rgba(0,0,0,0.5); display: flex; flex-direction: column; max-height: 85vh; color: var(--text); }
        .bottom-sheet.show { bottom: 0; }
        .sheet-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .sheet-header h3 { margin: 0; font-size: 18px; }
        .sheet-body { overflow-y: auto; padding: 20px; flex: 1; }

        #selectionSheet { z-index: 2200; }

        .sheet-btn-container { display: flex; gap: 15px; }
        .sheet-btn { flex: 1; padding: 15px; border-radius: 15px; border: none; font-weight: bold; font-size: 16px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 10px; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .sheet-btn.withdraw { background: var(--input-bg); color: #ff4747; border: 2px solid #ff4747; }
        .sheet-btn.deposit { background: var(--input-bg); color: #47ff78; border: 2px solid #47ff78; }

        /* Search Bar */
        .search-wrapper { position: relative; margin-bottom: 15px; }
        .search-input { width: 100%; padding: 12px 15px 12px 40px; border-radius: 12px; background: var(--input-bg); border: 1px solid var(--border); color: var(--text); outline: none; font-size: 14px; box-sizing: border-box; transition: 0.3s; }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(255, 43, 43, 0.1); }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-sec); font-size: 14px; pointer-events: none; }

        .input-group { position: relative; width: 100%; margin-bottom: 12px; }
        .input-group input { padding-right: 140px; margin-bottom: 0; }
        .calc-display { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--text-sec); font-size: 13px; font-weight: 600; pointer-events: none; display: none; background: transparent; }

        /* Method Items */
        .method-item { display: flex; align-items: center; gap: 15px; padding: 12px; background: var(--input-bg); border-radius: 12px; margin-bottom: 10px; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
        .method-item:hover { border-color: var(--primary); transform: translateX(5px); }
        .method-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .method-info { flex: 1; }
        .method-name { font-weight: bold; font-size: 14px; color: var(--text); }
        .method-desc { font-size: 11px; color: var(--text-sec); display: block; margin-top: 2px; }

        /* Task Styles */
        .task-card { background: var(--card); border-radius: 15px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); }
        .task-top-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .task-img-small { width: 45px; height: 45px; border-radius: 10px; object-fit: cover; flex-shrink: 0; }
        .task-main { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .task-caption { font-size: 14px; font-weight: 600; color: var(--text); line-height: 1.2; }
        .task-reward-row { margin-top: 12px; border-top: 1px solid var(--border); padding-top: 8px; }
        .task-reward-text { color: #47ff78; font-size: 13px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .task-btn-large { padding: 10px 20px; font-size: 14px; border-radius: 50px; min-width: 90px; margin: 0; background: var(--gradient); color: white; border: none; font-weight: bold; box-shadow: 0 4px 10px rgba(255, 43, 43, 0.3); cursor: pointer; transition: 0.2s; }
        .task-btn-large:disabled { background: var(--input-bg); color: var(--text-sec); box-shadow: none; border: 1px solid var(--border); }

        .refer-stats-container { background: var(--input-bg); border-radius: 12px; padding: 15px; display: flex; justify-content: space-between; margin-bottom: 15px; border: 1px solid var(--border); }
        .refer-stat { flex: 1; text-align: center; } .refer-stat:first-child { border-right: 1px solid var(--border); }
        .refer-title { font-size: 12px; color: var(--text-sec); margin-bottom: 5px; } .refer-val { font-size: 20px; font-weight: bold; color: var(--text); } .refer-val.earnings { color: #ff2b2b; } 
        
        .lb-item { display: flex; align-items: center; justify-content: space-between; background: var(--input-bg); padding: 12px 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid var(--border); transition: 0.2s; }
        .lb-item:hover { border-color: var(--primary); transform: translateX(3px); }
        .lb-left { display: flex; align-items: center; gap: 15px; } 
        .lb-rank { width: 30px; text-align: center; font-weight: bold; font-size: 16px; color: var(--text-sec); }
        .lb-img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--border); object-fit: cover; } 
        .lb-info { display: flex; flex-direction: column; }
        .lb-name { font-weight: bold; font-size: 14px; color: var(--text); display: flex; align-items: center; gap: 5px; }
        .lb-refs { font-size: 13px; font-weight: bold; color: var(--primary); background: rgba(255, 43, 43, 0.1); padding: 4px 10px; border-radius: 20px; }
        .rank-1 i { color: #FFD700; font-size: 22px; filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.5)); } 
        .rank-2 i { color: #C0C0C0; font-size: 20px; } .rank-3 i { color: #CD7F32; font-size: 20px; }
        
        .floating-support { position: fixed; bottom: 75px; right: 20px; background: #0088cc; width: 50px; height: 50px; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 15px rgba(0,136,204,0.5); z-index: 99; cursor: pointer; animation: floatAnim 3s ease-in-out infinite; }
        @keyframes floatAnim { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .floating-support i { color: white; font-size: 24px; }
    </style>
</head>
<body class="dark-mode">

    <div id="loadingScreen">
        <img src="https://i.ibb.co.com/PZc14DXD/20260222-151038.png" class="pulse-logo" id="loadingLogo">
    </div>

    <div id="mainApp" style="display:none;">
        <div class="header">
            <div class="user-info">
                <img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" id="headPhoto" class="user-img">
                <div class="user-details">
                    <p class="user-name" id="headName">User</p>
                    <div class="balance-capsule">৳ <span id="headBal">0.00</span></div>
                </div>
            </div>
            <div class="header-actions">
                <div class="wallet-custom-btn" onclick="openWalletSheet()">
                    <i class="fa-solid fa-wallet"></i> Wallet
                </div>
            </div>
        </div>

        <!-- HOME -->
        <div id="home" class="section active">
            <div id="bannerCon" class="banner-container"></div>
            <h3 style="margin-top:15px;">Exclusive Offers</h3>
            <div id="offerCon"></div>
        </div>

        <!-- EXCHANGE -->
        <div id="exchange" class="section">
            <div class="card">
                <h3>Exchange Currency</h3>
                <div id="sendTrigger" class="select-trigger" onclick="openSelectSheet('send')">
                    <span>Select Send Method</span>
                    <i class="fa-solid fa-chevron-down"></i>
                </div>
                <input type="hidden" id="sendM">

                <div id="walletDiv" style="display:none; background:rgba(255, 43, 43, 0.05); padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid var(--primary);">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px; border-bottom:1px solid var(--border); padding-bottom:8px;">
                        <span style="font-size:12px; color:var(--text-sec);">Rate: <b style="color:var(--text);" id="infoRate">0 BDT</b></span>
                        <span style="font-size:12px; color:var(--text-sec);">Min: <b style="color:var(--text);">$<span id="infoMin">0</span></b></span>
                    </div>
                    <small style="color:var(--primary); font-weight:bold;">Send Address:</small>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
                        <span id="admWallet" style="font-family:monospace; color:var(--text); font-size:13px; word-break: break-all;">...</span>
                        <i class="fa-solid fa-copy" onclick="cp('admWallet')" style="color:var(--primary); cursor:pointer; font-size:16px;"></i>
                    </div>
                </div>
                
                <div class="input-group">
                    <input type="number" id="exAmt" class="form-control" placeholder="Amount ($)" oninput="calcExchange()">
                    <span class="calc-display" id="calcSpan">= <b id="calcResInside"></b></span>
                </div>
                <input type="text" id="exTrx" class="form-control" placeholder="Trx ID">
                
                <div id="recTrigger" class="select-trigger" onclick="openSelectSheet('receive')">
                    <span>Select Receive Wallet</span>
                    <i class="fa-solid fa-chevron-down"></i>
                </div>
                <input type="hidden" id="recM">
                
                <input type="number" id="exNum" class="form-control" placeholder="Your Wallet Number">
                <button class="btn" onclick="reqExchange()">Exchange Now</button>
            </div>
        </div>

        <!-- HISTORY -->
        <div id="history" class="section">
            <h3>Activity Log</h3>
            <div id="histList"></div>
        </div>

        <!-- REFER -->
        <div id="refer" class="section">
            <div class="card">
                <h3>Invite & Earn</h3>
                <p>Invite users! When they exchange, you get <b>1.5% Commission</b> directly to your Main Balance.</p>
                <div class="refer-stats-container">
                    <div class="refer-stat"><div class="refer-title">Total Refer</div><div class="refer-val" id="refCount">0</div></div>
                    <div class="refer-stat"><div class="refer-title">Earnings</div><div class="refer-val earnings">৳ <span id="refEarn">0.00</span></div></div>
                </div>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="refLinkInput" class="form-control" readonly style="margin:0;">
                    <button class="btn" style="width:60px;" onclick="copyRefLink()"><i class="fa-solid fa-copy"></i></button>
                </div>
            </div>
            <h3 style="margin-top:20px; color:var(--text);">Top 20 Leaders</h3>
            <div id="topList" style="padding-bottom:20px;"><p style="text-align:center;">Loading...</p></div>
        </div>

        <!-- EARN -->
        <div id="earn" class="section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; font-weight:800;">Micro Tasks</h3>
                <button class="offer-btn" onclick="openCreateTask()" style="margin:0; background: var(--gradient); box-shadow: 0 4px 10px rgba(255,43,43,0.3);">+ Create Task</button>
            </div>
            <div id="taskList" style="padding-bottom:20px;">
                <p style="text-align:center; color:var(--text-sec); padding:20px;">Loading tasks...</p>
            </div>
        </div>

        <!-- NAV -->
        <div class="nav">
            <div class="nav-item active" onclick="nav('home', this)"><i class="fa-solid fa-house"></i>Home</div>
            <div class="nav-item" onclick="nav('exchange', this)"><i class="fa-solid fa-right-left"></i>Swap</div>
            <div class="nav-item" id="navHistory" onclick="nav('history', this)"><i class="fa-solid fa-clock-rotate-left"></i>History</div>
            <div class="nav-item" onclick="nav('refer', this)"><i class="fa-solid fa-users"></i>Refer</div>
            <div class="nav-item" onclick="nav('earn', this)"><i class="fa-solid fa-gift"></i>Earn</div>
        </div>

        <div class="floating-support" onclick="openSupport()">
            <i class="fa-brands fa-telegram"></i>
        </div>

        <!-- SHEETS -->
        <div id="selectionSheet" class="bottom-sheet">
            <div class="sheet-header">
                <h3 id="selectSheetTitle">Select Method</h3>
                <i class="fa-solid fa-xmark" style="font-size:24px; cursor:pointer;" onclick="closeSheet('selectionSheet')"></i>
            </div>
            <div id="searchWrapper" style="padding:10px 20px 0 20px;">
                <div class="search-wrapper">
                    <i class="fa-solid fa-magnifying-glass search-icon"></i>
                    <input type="text" id="methodSearch" class="search-input" placeholder="Search method..." oninput="filterMethods()">
                </div>
            </div>
            <div id="methodList" class="sheet-body"></div>
        </div>

        <div id="walletSheet" class="bottom-sheet">
            <div class="sheet-header">
                <h3>My Wallet</h3>
                <i class="fa-solid fa-xmark" style="font-size:24px; cursor:pointer;" onclick="closeSheet('walletSheet')"></i>
            </div>
            <div class="sheet-body">
                <div class="sheet-btn-container">
                    <button class="sheet-btn withdraw" onclick="openWithdraw()">
                        <i class="fa-solid fa-money-bill-transfer" style="font-size:24px;"></i>
                        Withdraw
                    </button>
                    <button class="sheet-btn deposit" onclick="openDeposit()">
                        <i class="fa-solid fa-circle-dollar-to-slot" style="font-size:24px;"></i>
                        Deposit
                    </button>
                </div>
            </div>
        </div>

        <div id="withdrawSheet" class="bottom-sheet">
            <div class="sheet-header">
                <h3>Withdraw Money</h3>
                <i class="fa-solid fa-xmark" style="font-size:24px; cursor:pointer;" onclick="closeSheet('withdrawSheet')"></i>
            </div>
            <div class="sheet-body" id="wFormDiv">
                <div style="margin-bottom:15px; text-align:center;">
                    <p style="margin:0; font-size:13px; color:var(--text-sec);">Current Balance</p>
                    <h2 style="margin:5px 0; color:var(--primary);">৳ <span id="wPopBal">0.00</span></h2>
                </div>
                <label style="font-size:12px; color:var(--text-sec); margin-left:5px;">Withdraw Method</label>
                <div id="withTrigger" class="select-trigger" onclick="openSelectSheet('withdraw')">
                    <span>Select Method</span>
                    <i class="fa-solid fa-chevron-down"></i>
                </div>
                <input type="hidden" id="wMethod">
                <div id="wInputs">
                    <label style="font-size:12px; color:var(--text-sec); margin-left:5px;">Wallet Number</label>
                    <input type="number" id="wNumber" class="form-control" placeholder="01XXX...">
                    <label style="font-size:12px; color:var(--text-sec); margin-left:5px;">Amount</label>
                    <input type="number" id="wAmount" class="form-control" placeholder="Min 10 ৳">
                    <button class="btn" onclick="submitWithdraw()">Confirm Withdraw</button>
                </div>
                <div id="wOffMsg" style="display:none; color:red; margin-top:10px; text-align:center;"></div>
            </div>
        </div>

        <div id="depositSheet" class="bottom-sheet">
            <div class="sheet-header">
                <h3>Deposit Money</h3>
                <i class="fa-solid fa-xmark" style="font-size:24px; cursor:pointer;" onclick="closeSheet('depositSheet')"></i>
            </div>
            <div class="sheet-body">
                <p style="font-size:12px; color:var(--text-sec); margin-bottom:10px;">Select method to see payment details.</p>
                <div id="depTrigger" class="select-trigger" onclick="openSelectSheet('deposit')">
                    <span>Select Deposit Method</span>
                    <i class="fa-solid fa-chevron-down"></i>
                </div>
                <input type="hidden" id="depMethodSelect">
                <div id="depInfo" style="display:none; background:rgba(71, 255, 120, 0.05); padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid #47ff78; text-align:left;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span style="font-size:12px; color:var(--text);">Send Number:</span>
                        <span style="font-size:12px; color:#47ff78; font-weight:bold;">Min: <span id="depMinAmt">0</span>৳</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <b id="depNum" style="font-family:monospace; font-size:16px; color:var(--text);">...</b> 
                        <i class="fa-solid fa-copy" onclick="cp('depNum')" style="cursor:pointer; color:var(--primary);"></i>
                    </div>
                </div>
                <input type="number" id="depAmount" class="form-control" placeholder="Amount (৳)">
                <input type="text" id="depTrx" class="form-control" placeholder="TrxID / Sender Number">
                <button class="btn" onclick="submitDeposit()">Submit Deposit</button>
            </div>
        </div>

        <div id="createTaskSheet" class="bottom-sheet">
            <div class="sheet-header">
                <h3>Create New Task</h3>
                <i class="fa-solid fa-xmark" style="font-size:24px; cursor:pointer;" onclick="closeSheet('createTaskSheet')"></i>
            </div>
            <div class="sheet-body">
                <div style="text-align:left;">
                    <label style="font-size:12px; color:var(--text-sec);">Select Task Type</label>
                    <select id="taskType" class="form-control" onchange="checkTaskType()">
                        <option value="Link">Link Visit (15s Timer)</option>
                        <option value="Channel">Telegram Channel Join</option>
                    </select>
                    <label style="font-size:12px; color:var(--text-sec);">Task Image</label>
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
                        <input type="file" id="taskImgFile" class="form-control" accept="image/*" onchange="uploadTaskImage()" style="margin:0;">
                        <div id="imgPreview" style="width:40px; height:40px; border-radius:5px; background:#333; display:none; background-size:cover;"></div>
                    </div>
                    <input type="hidden" id="taskImgUrl">
                    <p id="uploadStatus" style="font-size:11px; color:var(--primary); margin: -8px 0 10px 0; display:none;">Uploading...</p>
                    <input type="text" id="taskCaption" class="form-control" placeholder="Caption (Short Description)">
                    <input type="text" id="taskLink" class="form-control" placeholder="Channel Username (@name) or Link">
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="taskCount" class="form-control" placeholder="Target Users" oninput="calcTaskCost()">
                        <input type="number" id="taskReward" class="form-control" placeholder="Reward (৳)" oninput="calcTaskCost()">
                    </div>
                    <p style="font-size:13px; color:var(--text-sec); margin:0 0 10px 0;">
                        Total Cost: <span style="color:var(--primary); font-weight:bold;">৳ <span id="taskTotalCost">0</span></span>
                        <br><small id="balStatus" style="color:#666;"></small>
                    </p>
                    <button class="btn" onclick="submitCreateTask()">Create Now</button>
                </div>
            </div>
        </div>

        <div id="adminAlertPopup" class="popup" style="z-index: 3002;">
            <div class="popup-content">
                <i class="fa-solid fa-robot" style="font-size:40px; color:#1da1f2; margin-bottom:15px;"></i>
                <h3>Bot Admin Required</h3>
                <p style="font-size:13px;">For "Join Check" to work:</p>
                <ul style="font-size:12px; text-align:left; color:var(--text-sec);">
                    <li>Add this bot as Admin in your channel.</li>
                    <li>Use format: <b>@channelname</b></li>
                </ul>
                <button class="btn" onclick="openTelegramForAdmin()">Make Admin</button>
                <button class="btn" style="background:transparent; border:1px solid var(--border); margin-top:5px; color:var(--text);" onclick="closePop('adminAlertPopup')">I Understand</button>
            </div>
        </div>

        <div id="joinPopup" class="popup">
            <div class="popup-content">
                <i class="fa-brands fa-telegram" style="font-size:40px; color:var(--primary); margin-bottom:15px;"></i>
                <h3>Join Community</h3>
                <p>You must join our official channel to use this bot.</p>
                <div class="popup-btn-container">
                    <button class="btn" onclick="openChannel()">Join Channel</button>
                    <button class="btn" id="verifyBtn" style="background:var(--input-bg); color:var(--text); border:1px solid var(--border);" onclick="manualVerify()">I Joined</button>
                </div>
                <p id="verifyMsg" style="font-size:12px; margin-top:10px; color:red; display:none;"></p>
            </div>
        </div>

        <div id="feePopup" class="popup" style="z-index: 3001;">
            <div class="popup-content">
                <i class="fa-solid fa-circle-info" style="font-size:40px; color:var(--primary); margin-bottom:15px;"></i>
                <h3 style="margin-top:0;">Fee Notice</h3>
                <p class="fee-warning" id="feeText">...</p>
                <button class="btn fee-btn" onclick="closePop('feePopup')">Ok</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, onSnapshot, query, where, orderBy, increment, serverTimestamp, limit, arrayUnion } 
        from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

        // IMPORTANT: Replace with your actual Render URL (No trailing slash)
        const BACKEND_URL = "https://dollar-bot-server.onrender.com"; 

        const firebaseConfig = {
          apiKey: "AIzaSyDYUGAUdAg6_6-vacGnQfZ2tyXBC1vHYTA",
          authDomain: "redoexchange-bbac4.firebaseapp.com",
          projectId: "redoexchange-bbac4",
          storageBucket: "redoexchange-bbac4.firebasestorage.app",
          messagingSenderId: "419809399280",
          appId: "1:419809399280:web:f618f5ea28b810d905cd35"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const tg = window.Telegram.WebApp;
        tg.expand();

        let settings = null;
        let globalMethods = []; 
        let globalDepMethods =[];
        let methodMap = {}; 
        let depMethodMap = {};
        
        const localWallets =[
            { name: "Bkash", image: "https://i.ibb.co.com/fYGQL5td/1656235223bkash-logo.png" },
            { name: "Nagad", image: "https://i.ibb.co.com/ychhHJJK/images-4.png" },
            { name: "Binance", image: "https://i.ibb.co.com/qFkp7HKf/unnamed-1.png" }
        ];

        let isMember = false;
        let minWithdraw = 10;
        let userData = {};
        const user = tg.initDataUnsafe.user || { id: "112233", first_name: "Guest", username: "guest" };
        const uid = user.id.toString();

        let currentSelectionType = ''; 
        let currentList =[];

        async function init() {
            if (tg.colorScheme === 'light') {
                document.body.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
            } else {
                document.body.classList.add('dark-mode');
                document.body.classList.remove('light-mode');
            }

            onAuthStateChanged(auth, async (u) => {
                if (u) {
                    startDataListeners();
                } else {
                    try { await signInAnonymously(auth); } catch (e) { console.error(e); }
                }
            });
        }

        function startDataListeners() {
            onSnapshot(doc(db, "settings", "appConfig"), async (s) => { 
                if(s.exists()) {
                    settings = s.data();
                    if(settings.loadingImage) document.getElementById('loadingLogo').src = settings.loadingImage;
                    document.getElementById('refLinkInput').value = `https://t.me/${settings.botUsername}?startapp=${uid}`;
                    minWithdraw = settings.minWithdrawAmount || 10;
                    document.getElementById('wAmount').placeholder = `Amount (Min ${minWithdraw} ৳)`;
                    verifyJoin(true); 
                    setTimeout(() => { document.getElementById('loadingScreen').style.opacity='0'; setTimeout(()=>{ document.getElementById('loadingScreen').style.display='none'; document.getElementById('mainApp').style.display='block'; }, 500); }, 1500); 
                } 
            });

            onSnapshot(collection(db, "exchange_methods"), s => {
                globalMethods =[];
                methodMap = {};
                s.forEach(d => { 
                    const data = d.data();
                    const item = { ...data, id: d.id };
                    globalMethods.push(item);
                    methodMap[data.name] = { wallet: data.wallet, rate: data.rate || 0, min: data.min || 5, image: data.image }; 
                });
            });

            onSnapshot(collection(db, "deposit_methods"), s => {
                globalDepMethods =[];
                depMethodMap = {};
                s.forEach(d => {
                    const data = d.data();
                    const item = { ...data, id: d.id };
                    globalDepMethods.push(item);
                    depMethodMap[data.name] = { number: data.number, min: data.minAmount || 0, image: data.image };
                });
            });

            checkUser();
            startTaskListener();
            
            onSnapshot(collection(db, "banners"), s => {
                const bC = document.getElementById('bannerCon'); bC.innerHTML = "";
                s.forEach(d => {
                    const b = d.data();
                    const btnText = b.btnText || "Open";
                    bC.innerHTML += `
                    <div class="banner-slide">
                        <img src="${b.image}" onclick="window.open('${b.link}','_blank')">
                        <div class="banner-btn" onclick="window.open('${b.link}','_blank')">${btnText}</div>
                    </div>`;
                });
                startBannerSlide();
            });

            onSnapshot(collection(db, "offers"), s => {
                const oC = document.getElementById('offerCon'); oC.innerHTML = "";
                s.forEach(d => {
                    const o = d.data();
                    // Changed: Button text "Open", style handled by .offer-btn CSS
                    oC.innerHTML += `<div class="card" style="display:flex; gap:15px; align-items:center;"><img src="${o.image}" width="50" height="50" style="border-radius:12px; object-fit:cover;"><div style="flex:1;"><b style="font-size:15px;">${o.title}</b><br><a href="${o.link}" class="offer-btn" target="_blank">Open</a></div></div>`;
                });
            });

            const qHistory = query(collection(db, "requests"), where("userId", "==", uid));
            onSnapshot(qHistory, (s) => {
                const h = document.getElementById('histList'); h.innerHTML = "";
                if(s.empty) { h.innerHTML = "<p style='text-align:center; color:var(--text-sec);'>No history found</p>"; } 
                else {
                    let historyArray =[];
                    s.forEach(d => { historyArray.push({ id: d.id, ...d.data() }); });
                    historyArray.sort((a, b) => { const dateA = a.date ? a.date.seconds : 0; const dateB = b.date ? b.date.seconds : 0; return dateB - dateA; });

                    historyArray.forEach(r => {
                        let col = r.status==='Approved'?'green': r.status==='Rejected'?'red':'orange';
                        let txt = r.type==="Exchange" ? `${r.sendMethod} -> ${r.receiveMethod}` : `${r.type}: ${r.method || 'Manual'}`;
                        let amt = r.type==="Exchange" ? `$${r.amount}` : `৳${r.amount}`;
                        h.innerHTML += `<div class="card" style="padding:15px; display:flex; justify-content:space-between; align-items:center;"><div><b style="color:var(--primary);">${r.type}</b><br><small style="color:var(--text-sec);">${txt}</small><br><b style="font-size:14px;">${amt}</b></div><div style="text-align:right;"><span style="color:${col}; font-weight:bold; font-size:12px; border:1px solid ${col}; padding:3px 8px; border-radius:10px;">${r.status}</span><br><small style="font-size:10px; color:var(--text-sec);">${r.date ? new Date(r.date.seconds * 1000).toLocaleDateString() : ''}</small></div></div>`;
                    });
                }
            });
            
            const qUsers = query(collection(db, "users"), orderBy("referrals", "desc"), limit(20));
            onSnapshot(qUsers, (s) => {
                const l = document.getElementById('topList'); l.innerHTML = "";
                let i = 1;
                s.forEach(d => {
                    const u = d.data();
                    let rankIcon = i;
                    if(i === 1) rankIcon = '<i class="fa-solid fa-trophy rank-1"></i>';
                    else if(i === 2) rankIcon = '<i class="fa-solid fa-medal rank-2"></i>';
                    else if(i === 3) rankIcon = '<i class="fa-solid fa-medal rank-3"></i>';
                    else rankIcon = `<span class="lb-rank">#${i}</span>`;
                    
                    let uName = u.name.substring(0,15);
                    if((u.referrals || 0) >= 100) uName += ` <span class="verified-badge" style="width:12px; height:12px; font-size:8px;"><i class="fa-solid fa-check"></i></span>`;
                    
                    l.innerHTML += `
                    <div class="lb-item">
                        <div class="lb-left">
                            <div style="width:25px; text-align:center;">${rankIcon}</div>
                            <img src="${u.photo||'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" class="lb-img">
                            <div class="lb-info">
                                <span class="lb-name">${uName}</span>
                            </div>
                        </div>
                        <span class="lb-refs">${u.referrals || 0} Ref</span>
                    </div>`;
                    i++;
                });
            });
        }

        window.openSelectSheet = (type) => {
            currentSelectionType = type;
            const sheet = document.getElementById('selectionSheet');
            const searchInput = document.getElementById('methodSearch');
            
            searchInput.value = "";
            document.getElementById('methodList').innerHTML = "";
            
            let data =[];
            if(type === 'send') {
                document.getElementById('searchWrapper').style.display = "block";
                data = globalMethods;
            } else if (type === 'receive') {
                document.getElementById('searchWrapper').style.display = "none";
                data = localWallets;
            } else if (type === 'withdraw') {
                document.getElementById('searchWrapper').style.display = "none";
                data = localWallets.filter(item => item.name === 'Bkash' || item.name === 'Binance');
            } else if (type === 'deposit') {
                document.getElementById('searchWrapper').style.display = "block";
                data = globalDepMethods;
            }
            
            currentList = data;
            renderMethodList(data);
            sheet.classList.add('show');
        };

        window.closeSheet = (id) => {
            document.getElementById(id).classList.remove('show');
        };

        window.renderMethodList = (list) => {
            const container = document.getElementById('methodList');
            container.innerHTML = "";
            
            list.forEach(item => {
                const img = item.image || 'https://cdn-icons-png.flaticon.com/512/1175/1175249.png'; 
                let detailText = "";
                
                if(currentSelectionType === 'send') {
                    detailText = `Rate: ${item.rate || 0} ৳ | Min: $${item.min || 0}`;
                } else if(currentSelectionType === 'deposit') {
                    detailText = `Min Deposit: ${item.minAmount || 0} ৳`;
                } else if(currentSelectionType === 'receive' || currentSelectionType === 'withdraw') {
                    detailText = "Personal"; 
                } else {
                    detailText = `Rate: 1$ = ${item.rate || 0} ৳`; 
                }

                const div = document.createElement('div');
                div.className = 'method-item';
                div.innerHTML = `
                    <img src="${img}" class="method-img">
                    <div class="method-info">
                        <div class="method-name">${item.name}</div>
                        <span class="method-desc">${detailText}</span>
                    </div>
                `;
                div.onclick = () => selectItem(item);
                container.appendChild(div);
            });
        };

        window.filterMethods = () => {
            const query = document.getElementById('methodSearch').value.toLowerCase();
            const filtered = currentList.filter(m => m.name.toLowerCase().includes(query));
            renderMethodList(filtered);
        };

        window.selectItem = (item) => {
            const name = item.name;
            closeSheet('selectionSheet');

            if(currentSelectionType === 'send') {
                document.getElementById('sendM').value = name;
                document.querySelector('#sendTrigger span').innerText = name;
                document.getElementById('sendTrigger').classList.add('selected');
                updWallet();
            } else if (currentSelectionType === 'receive') {
                document.getElementById('recM').value = name;
                document.querySelector('#recTrigger span').innerText = name;
                document.getElementById('recTrigger').classList.add('selected');
                checkFeeWarning();
            } else if (currentSelectionType === 'deposit') {
                document.getElementById('depMethodSelect').value = name;
                document.querySelector('#depTrigger span').innerText = name;
                document.getElementById('depTrigger').classList.add('selected');
                updDepInfo();
            } else if (currentSelectionType === 'withdraw') {
                document.getElementById('wMethod').value = name;
                document.querySelector('#withTrigger span').innerText = name;
                document.getElementById('withTrigger').classList.add('selected');
            }
        };

        window.openWalletSheet = () => { document.getElementById('walletSheet').classList.add('show'); };
        
        window.openWithdraw = () => { 
            closeSheet('walletSheet');
            document.getElementById('withdrawSheet').classList.add('show'); 
            
            if(settings && settings.withdrawStatus) { 
                document.getElementById('wInputs').style.display='block'; 
                document.getElementById('wOffMsg').style.display='none'; 
            } else { 
                document.getElementById('wInputs').style.display='none'; 
                document.getElementById('wOffMsg').style.display='block'; 
                document.getElementById('wOffMsg').innerText = (settings && settings.withdrawNotice) ? settings.withdrawNotice : "Closed"; 
            } 
        };

        window.openDeposit = () => {
            closeSheet('walletSheet');
            document.getElementById('depositSheet').classList.add('show');
        };

        window.updDepInfo = () => {
            const m = document.getElementById('depMethodSelect').value;
            const div = document.getElementById('depInfo');
            if(m && depMethodMap[m]) {
                div.style.display = "block";
                document.getElementById('depNum').innerText = depMethodMap[m].number;
                document.getElementById('depMinAmt').innerText = depMethodMap[m].min;
            } else {
                div.style.display = "none";
            }
        };

        window.submitDeposit = async () => {
            const amt = parseFloat(document.getElementById('depAmount').value);
            const trx = document.getElementById('depTrx').value;
            const meth = document.getElementById('depMethodSelect').value;
            
            if(!amt || !trx || !meth) return alert("Fill all fields");
            if(depMethodMap[meth] && amt < depMethodMap[meth].min) return alert(`Minimum deposit ${depMethodMap[meth].min} ৳`);

            await addDoc(collection(db, "requests"), {
                userId: uid, userName: user.first_name, type: "Deposit",
                amount: amt, method: meth, trxId: trx, status: "Pending", date: serverTimestamp(),
                referrerId: userData.referredBy || null
            });
            alert("Deposit Request Submitted! Please wait for admin approval.");
            closeSheet('depositSheet');
            nav('history', document.getElementById('navHistory'));
        };

        window.submitWithdraw = async () => { 
            const amount = document.getElementById('wAmount').value; 
            const meth = document.getElementById('wMethod').value; 
            const num = document.getElementById('wNumber').value; 
            if(!amount || !meth || !num) return alert("Fill all fields"); 
            if(parseFloat(amount) < minWithdraw) return alert("Min Withdraw " + minWithdraw + " ৳"); 
            if(parseFloat(amount) > (userData.mainBalance || 0)) return alert("Insufficient Balance");
            
            await updateDoc(doc(db, "users", uid), { mainBalance: increment(-parseFloat(amount)) }); 
            await addDoc(collection(db, "requests"), { 
                userId: uid, userName: user.first_name, userPhoto: userData.photo||"", 
                totalReferrals: userData.referrals||0, currentMainBalance: (userData.mainBalance-parseFloat(amount)), 
                type: "Withdraw", amount: parseFloat(amount), method: meth, userNumber: num, 
                status: "Pending", date: serverTimestamp() 
            }); 
            alert("Withdraw Submitted! Balance deducted."); closeSheet('withdrawSheet'); nav('history', document.getElementById('navHistory')); 
        };

        // User Data
        async function checkUser() {
            const uRef = doc(db, "users", uid);
            const snap = await getDoc(uRef);
            
            if (!snap.exists()) {
                const startParam = tg.initDataUnsafe.start_param; 
                let referrer = null;
                if(startParam && startParam.toString() !== uid) referrer = startParam.toString();
                
                await setDoc(uRef, { 
                    name: user.first_name, username: user.username||"", 
                    balance: 0, mainBalance: 0, photo: user.photo_url||"", 
                    joined: serverTimestamp(), referrals: 0, refEarnings: 0,
                    referredBy: referrer, banned: false
                });
                if(referrer) { 
                    try { 
                        await updateDoc(doc(db, "users", referrer), { referrals: increment(1) }); 
                        fetch(`${BACKEND_URL}/api/notify-refer-join`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                referrerId: referrer,
                                firstName: user.first_name,
                                newUserName: user.username || "User"
                            })
                        }).catch(e => console.log("Refer Notify Error:", e));
                    } catch(e) { console.error(e); } 
                }
            }
            
            onSnapshot(uRef, s => {
                userData = s.data();
                if(userData.banned) { document.body.innerHTML = "<h1>BANNED</h1>"; return; }

                let nameHtml = userData.name;
                if((userData.referrals || 0) >= 100) nameHtml += ` <span class="verified-badge"><i class="fa-solid fa-check"></i></span>`;
                document.getElementById('headName').innerHTML = nameHtml;
                document.getElementById('headBal').innerText = (userData.mainBalance || 0).toFixed(2);
                document.getElementById('wPopBal').innerText = (userData.mainBalance || 0).toFixed(2);
                if(userData.photo) document.getElementById('headPhoto').src = userData.photo;
                document.getElementById('refCount').innerText = userData.referrals || 0;
                document.getElementById('refEarn').innerText = (userData.refEarnings || 0).toFixed(2);
            });
        }

        /* --- OTHER UTILS --- */
        let slideInterval;
        function startBannerSlide() {
            if(slideInterval) clearInterval(slideInterval);
            const con = document.getElementById('bannerCon');
            slideInterval = setInterval(() => {
                if(con.scrollLeft + con.clientWidth >= con.scrollWidth - 10) con.scrollTo({left: 0, behavior: 'smooth'});
                else con.scrollBy({left: con.clientWidth, behavior: 'smooth'});
            }, 3000);
        }

        /* --- TASK LOGIC --- */
        window.openCreateTask = () => { document.getElementById('createTaskSheet').classList.add('show'); };
        window.checkTaskType = () => { if(document.getElementById('taskType').value === 'Channel') document.getElementById('adminAlertPopup').style.display = 'flex'; };
        window.openTelegramForAdmin = () => { window.open("https://t.me/RedExChangerBot?startchannel=true", "_blank"); document.getElementById('adminAlertPopup').style.display = 'none'; };
        
        window.calcTaskCost = () => {
            const count = parseInt(document.getElementById('taskCount').value) || 0;
            const reward = parseFloat(document.getElementById('taskReward').value) || 0;
            const total = count * reward;
            document.getElementById('taskTotalCost').innerText = total.toFixed(2);
            const status = document.getElementById('balStatus');
            if(userData.mainBalance < total) { status.innerText = "Insufficient Balance"; status.style.color = "red"; } 
            else { status.innerText = "Balance Available"; status.style.color = "green"; }
        };

        // NEW: Upload Task Image
        window.uploadTaskImage = async () => {
            const fileInput = document.getElementById('taskImgFile');
            const file = fileInput.files[0];
            if (!file) return;

            document.getElementById('uploadStatus').style.display = 'block';
            document.getElementById('uploadStatus').innerText = "Uploading image...";
            document.getElementById('uploadStatus').style.color = "orange";

            const formData = new FormData();
            formData.append("image", file);
            
            try {
                // Using ImgBB for free image hosting
                const response = await fetch("https://api.imgbb.com/1/upload?key=a26bed1b2fd07ba03bff75343d0834fe", {
                    method: "POST",
                    body: formData
                });
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('taskImgUrl').value = data.data.url;
                    const preview = document.getElementById('imgPreview');
                    preview.style.display = 'block';
                    preview.style.backgroundImage = `url('${data.data.url}')`;
                    document.getElementById('uploadStatus').innerText = "Image Uploaded Successfully!";
                    document.getElementById('uploadStatus').style.color = "#47ff78";
                } else {
                    throw new Error("Upload failed");
                }
            } catch (error) {
                console.error(error);
                document.getElementById('uploadStatus').innerText = "Upload Failed. Try again.";
                document.getElementById('uploadStatus').style.color = "red";
            }
        };

        window.submitCreateTask = async () => {
            const type = document.getElementById('taskType').value;
            const img = document.getElementById('taskImgUrl').value;
            const cap = document.getElementById('taskCaption').value;
            const linkRaw = document.getElementById('taskLink').value;
            const count = parseInt(document.getElementById('taskCount').value);
            const reward = parseFloat(document.getElementById('taskReward').value);
            
            if(!img || !cap || !linkRaw || !count || !reward) return alert("Fill all fields and upload image");
            if(count < 5) return alert("Minimum target users must be at least 5.");
            if(reward < 0.1) return alert("Minimum reward must be at least 0.1 ৳.");
            
            const totalCost = count * reward;
            if((userData.mainBalance || 0) < totalCost) return alert("Insufficient Balance!");

            // --- AUTO-FIX LINK LOGIC ---
            let finalLink = linkRaw.trim();
            if(type === 'Channel') {
                finalLink = finalLink.replace(/(https?:\/\/)?(t\.me|telegram\.me)\//, '');
                if (!finalLink.startsWith('http') && !finalLink.startsWith('@')) {
                    finalLink = '@' + finalLink;
                }
            }

            if(confirm(`Create task for ${totalCost} BDT?`)) {
                try {
                    await updateDoc(doc(db, "users", uid), { mainBalance: increment(-totalCost) });
                    const docRef = await addDoc(collection(db, "tasks"), {
                        creatorId: uid, type: type, image: img, caption: cap, link: finalLink,
                        targetCount: count, reward: reward, completedCount: 0,
                        completedBy:[], active: true, createdAt: serverTimestamp()
                    });

                    // Broadcast
                    try {
                        fetch(`${BACKEND_URL}/api/broadcast-task`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                caption: cap,
                                target: count,
                                reward: reward,
                                link: 'https://t.me/RedExChangerBot/app'
                            })
                        });
                    } catch(err) { console.log("Broadcast failed", err); }

                    alert("Task Created!"); closeSheet('createTaskSheet');
                } catch(e) { console.error(e); }
            }
        };

        function startTaskListener() {
            const q = query(collection(db, "tasks"), where("active", "==", true));
            onSnapshot(q, (s) => {
                const list = document.getElementById('taskList');
                list.innerHTML = "";
                let hasTasks = false;
                s.forEach(d => {
                    const t = d.data();
                    const tid = d.id;
                    if(t.completedCount < t.targetCount && (!t.completedBy || !t.completedBy.includes(uid))) {
                        hasTasks = true;
                        let actionBtn = "";
                        if(t.type === 'Link') actionBtn = `<button class="task-btn-large" id="btn-${tid}" onclick="handleLinkTask('${tid}', '${t.link}', ${t.reward})">Open</button>`;
                        else actionBtn = `<button class="task-btn-large" id="btn-${tid}" onclick="handleChannelTask('${tid}', '${t.link}', ${t.reward})">Join</button>`;

                        list.innerHTML += `
                        <div class="task-card">
                            <div class="task-top-row">
                                <img src="${t.image}" class="task-img-small">
                                <div class="task-main"><div class="task-caption">${t.caption}</div></div>
                                ${actionBtn}
                            </div>
                            <div class="task-reward-row"><div class="task-reward-text"><i class="fa-solid fa-coins"></i> Reward: ${t.reward} ৳</div></div>
                        </div>`;
                    }
                });
                if(!hasTasks) list.innerHTML = "<p style='text-align:center; color:var(--text-sec); padding:20px;'>No tasks available.</p>";
            });
        }

        window.handleLinkTask = (taskId, link, reward) => {
            window.open(link, '_blank');
            const btn = document.getElementById(`btn-${taskId}`);
            let timeLeft = 15; btn.disabled = true; btn.innerText = `Wait ${timeLeft}s`;
            const timer = setInterval(() => {
                timeLeft--; btn.innerText = `Wait ${timeLeft}s`;
                if(timeLeft <= 0) {
                    clearInterval(timer); btn.innerText = "Claim"; btn.style.background = "#47ff78"; btn.style.color = "black"; btn.disabled = false;
                    btn.onclick = () => showAdAndClaim(taskId, reward);
                }
            }, 1000);
        };

        window.handleChannelTask = (taskId, link, reward) => {
            let openLink = link;
            if(link.startsWith('@')) {
                openLink = `https://t.me/${link.substring(1)}`;
            }
            window.open(openLink, '_blank');
            const btn = document.getElementById(`btn-${taskId}`);
            btn.innerText = "Verify"; btn.style.background = "#47ff78"; btn.style.color = "black";
            btn.onclick = () => verifyChannelJoin(taskId, reward);
        };

        // --- UPDATED VERIFY FUNCTION ---
        async function verifyChannelJoin(taskId, reward) {
            const btn = document.getElementById(`btn-${taskId}`);
            btn.innerText = "Checking...";
            btn.disabled = true;

            try {
                const res = await fetch(`${BACKEND_URL}/api/verify-channel-task`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ userId: uid, taskId: taskId })
                });

                if (!res.ok) {
                    throw new Error(`Server error: ${res.status}`);
                }

                const data = await res.json();
                
                if(data.success) {
                    alert(`Success! Task Completed.`);
                    btn.innerText = "Claim";
                    btn.style.background = "#47ff78";
                    btn.style.color = "black";
                    btn.disabled = false;
                    btn.onclick = () => showAdAndClaim(taskId, reward);
                } else {
                    alert(data.message || "You have not joined the channel yet!");
                    btn.innerText = "Verify";
                    btn.disabled = false;
                }
            } catch(e) {
                console.error(e);
                alert("Connection Error. Check if Bot is Admin in the channel or Backend URL is correct.");
                btn.innerText = "Verify";
                btn.disabled = false;
            }
        }

        function showAdAndClaim(taskId, reward) {
            const btn = document.getElementById(`btn-${taskId}`); 
            btn.innerText = "Loading Ad..."; 
            btn.disabled = true;
            
            // New Ad Logic: Call the function defined in data-sdk='show_10481635'
            if(typeof show_10481635 === 'function') {
                show_10481635().then(() => {
                    claimReward(taskId, reward);
                }).catch(e => {
                    console.log("Ad Error:", e);
                    claimReward(taskId, reward); // Claim anyway if ad fails/blocked
                });
            } else {
                // Fallback if SDK not loaded
                setTimeout(() => { claimReward(taskId, reward); }, 1500);
            }
        }

        async function claimReward(taskId, reward) {
             const btn = document.getElementById(`btn-${taskId}`);
             try {
                 const tRef = doc(db, "tasks", taskId);
                 const tSnap = await getDoc(tRef);
                 if(tSnap.exists()) {
                     const td = tSnap.data();
                     if(td.completedCount < td.targetCount && !td.completedBy.includes(uid)) {
                         await updateDoc(doc(db, "users", uid), { mainBalance: increment(reward) });
                         await updateDoc(tRef, { completedCount: increment(1), completedBy: arrayUnion(uid) });
                         alert(`Claimed ${reward} ৳`); btn.innerText = "Done"; btn.disabled = true;
                     } else { alert("Task ended."); btn.innerText = "Done"; }
                 }
             } catch(e) { alert("Error"); }
        }

        window.updWallet = () => { 
            const m = document.getElementById('sendM').value; 
            const div = document.getElementById('walletDiv'); 
            if(methodMap[m]) { 
                div.style.display = "block"; 
                document.getElementById('admWallet').innerText = methodMap[m].wallet; 
                document.getElementById('infoRate').innerText = methodMap[m].rate + " ৳"; 
                document.getElementById('infoMin').innerText = methodMap[m].min; 
            } else { div.style.display = "none"; } 
            calcExchange(); 
        };

        window.calcExchange = () => { 
            const m = document.getElementById('sendM').value; 
            const amt = parseFloat(document.getElementById('exAmt').value); 
            if(methodMap[m] && amt > 0) { 
                document.getElementById('calcSpan').style.display = "block"; 
                document.getElementById('calcResInside').innerText = (amt * methodMap[m].rate).toFixed(2) + "৳"; 
            } else { document.getElementById('calcSpan').style.display = "none"; } 
        };

        window.checkFeeWarning = () => { 
            const recM = document.getElementById('recM').value; 
            if(recM === "Bkash" || recM === "Nagad") { 
                document.getElementById('feeText').innerText = recM === "Bkash" ? "বিকাশের মাধ্যমে Payment গ্রহণ করলে bkash নির্ধারিত ফি প্রযোজ্য হবে" : "নগদ এর মাধ্যমে Payment গ্রহণ করলে Nagad নির্ধারিত ফি প্রযোজ্য হবে"; 
                document.getElementById('feePopup').style.display = "flex"; 
            } 
        };

        window.reqExchange = async () => { 
            if(!isMember) { verifyJoin(false); return; }
            const sendM = document.getElementById('sendM').value; 
            const amt = document.getElementById('exAmt').value; 
            const trx = document.getElementById('exTrx').value; 
            const recM = document.getElementById('recM').value; 
            const num = document.getElementById('exNum').value; 
            
            if(!sendM || !amt || !trx || !recM || !num) return alert("Fill all fields"); 
            if(parseFloat(amt) < methodMap[sendM].min) return alert(`Min amount is $${methodMap[sendM].min}`); 
            
            const rate = methodMap[sendM].rate;
            const bdtAmount = (parseFloat(amt) * rate).toFixed(2);
            
            await addDoc(collection(db, "requests"), { 
                userId: uid, userName: user.first_name, userPhoto: userData.photo||"", 
                type: "Exchange", sendMethod: sendM, amount: parseFloat(amt), bdtAmount: bdtAmount, 
                trxId: trx, receiveMethod: recM, userNumber: num, referrerId: userData.referredBy||null, 
                status: "Pending", date: serverTimestamp() 
            }); 
            alert("Submitted!"); nav('history', document.getElementById('navHistory')); 
        };

        window.closePop = (id) => document.getElementById(id).style.display='none';
        window.nav = (n, e) => { if(!isMember && n !== 'home') { verifyJoin(false); return; } document.querySelectorAll('.section').forEach(x=>x.classList.remove('active')); document.getElementById(n).classList.add('active'); document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); e.classList.add('active'); };
        
        window.manualVerify = () => verifyJoin(false, true); 
        window.verifyJoin = async (silent = false, isManual = false) => { 
            if(!settings || !settings.requiredChannel) { isMember=true; document.getElementById('joinPopup').style.display='none'; return; } 
            if(isManual) { const btn = document.getElementById('verifyBtn'); btn.innerText = "Connecting..."; btn.disabled = true; }
            try { 
                const res = await fetch(`${BACKEND_URL}/api/verify-member`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId:uid, channelUsername:settings.requiredChannel}) }); 
                const data = await res.json(); 
                if(data.isMember) { isMember=true; document.getElementById('joinPopup').style.display='none'; if(isManual) { document.getElementById('verifyBtn').innerText = "I Joined"; document.getElementById('verifyBtn').disabled = false; } } 
                else { isMember=false; if(!silent) document.getElementById('joinPopup').style.display='flex'; if(isManual) { document.getElementById('verifyBtn').innerText = "Try Again"; document.getElementById('verifyBtn').disabled = false; document.getElementById('verifyMsg').style.display = 'block'; document.getElementById('verifyMsg').innerText = "Not joined yet!"; } } 
            } catch(e) { if(isManual) { document.getElementById('verifyBtn').innerText = "Try Again"; document.getElementById('verifyBtn').disabled = false; } } 
        };
        window.openChannel = () => window.open(`https://t.me/${settings.requiredChannel.replace('@','')}`, '_blank'); 
        window.openSupport = () => window.open(settings.supportLink, '_blank'); 
        window.cp = (id) => { navigator.clipboard.writeText(document.getElementById(id).innerText); alert("Copied"); }; 
        window.copyRefLink = () => { navigator.clipboard.writeText(document.getElementById('refLinkInput').value); alert("Copied"); };
        
        init();
    </script>
</body>
</html>
