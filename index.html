<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RedoExchange</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        :root { --primary: #ff2b2b; --bg: #0f0f0f; --card: #1e1e1e; --text: #ffffff; --text-sec: #aaaaaa; --border: #333333; --input-bg: #2b2b2b; --shadow: 0 4px 15px rgba(0,0,0,0.3); --gradient: linear-gradient(135deg, #ff2b2b 0%, #d50000 100%); --capsule-bg: rgba(255, 255, 255, 0.1); --verified: #1da1f2; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding-bottom: 90px; -webkit-font-smoothing: antialiased; }
        #loadingScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .pulse-logo { width: 100px; animation: breathe 2s infinite; border-radius: 20px; }
        @keyframes breathe { 0% { transform: scale(0.9); opacity: 0.7; } 50% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(0.9); opacity: 0.7; } }
        .popup { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; display:none; justify-content:center; align-items:center; backdrop-filter: blur(5px); }
        .popup-content { background: var(--card); padding: 25px 25px; width: 85%; max-width: 320px; border-radius: 20px; text-align: center; position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: popUpAnim 0.3s; }
        @keyframes popUpAnim { from{transform: scale(0.8); opacity: 0;} to{transform: scale(1); opacity: 1;} }
        .header { background: var(--card); padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 50; border-radius: 0 0 25px 25px; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        .user-details { display: flex; flex-direction: column; gap: 4px; }
        .user-name { font-weight: 700; font-size: 15px; margin: 0; display: flex; align-items: center; gap: 6px; }
        .verified-badge { color: #fff; background: var(--verified); border-radius: 50%; padding: 2px; font-size: 10px; width: 14px; height: 14px; display: inline-flex; align-items: center; justify-content: center; box-shadow: 0 0 8px rgba(29, 161, 242, 0.6); animation: verifyPulse 2s infinite; }
        @keyframes verifyPulse { 0% { box-shadow: 0 0 0 0 rgba(29, 161, 242, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(29, 161, 242, 0); } 100% { box-shadow: 0 0 0 0 rgba(29, 161, 242, 0); } }
        .balance-capsule { display: inline-flex; align-items: center; background: var(--capsule-bg); padding: 2px 10px; border-radius: 50px; font-size: 12px; font-weight: 700; color: var(--primary); width: fit-content; border: 1px solid rgba(255,43,43,0.2); }
        .icon-btn { font-size: 24px; color: #ffffff; cursor: pointer; margin-left: 15px; transition: 0.3s; filter: drop-shadow(0 0 8px rgba(255, 43, 43, 0.6)); }
        .icon-btn:hover { transform: scale(1.1); filter: drop-shadow(0 0 12px rgba(255, 43, 43, 1)); }
        .section { display: none; padding: 20px; animation: fadeIn 0.4s ease-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
        .card { background: var(--card); padding: 20px; border-radius: 20px; margin-bottom: 15px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .btn { width: 100%; padding: 14px; background: var(--gradient); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 15px; margin-top: 10px; box-shadow: 0 4px 10px rgba(255, 43, 43, 0.3); transition: transform 0.2s; }
        .btn:active { transform: scale(0.98); }
        .form-control { width: 100%; padding: 14px; background: var(--input-bg); border: 1px solid var(--border); color: var(--text); border-radius: 12px; margin-bottom: 12px; box-sizing: border-box; outline: none; transition: border 0.3s; }
        .form-control:focus { border-color: var(--primary); }
        .nav { position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; justify-content: space-around; padding: 15px 0 10px 0; border-top: 1px solid var(--border); z-index: 100; border-radius: 25px 25px 0 0; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); }
        .nav-item { text-align: center; color: var(--text-sec); font-size: 11px; width: 60px; transition: 0.3s; }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }
        .nav-item i { font-size: 20px; margin-bottom: 4px; display: block; }
        .close-pop { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: var(--text-sec); }
        .banner-container { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; gap: 15px; padding-bottom: 10px; } .banner-container::-webkit-scrollbar { display: none; } .banner-slide { min-width: 100%; scroll-snap-align: center; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); } .banner-slide img { width: 100%; display: block; }
        .offer-btn { background: linear-gradient(45deg, #FF512F 0%, #DD2476 100%); color: white; border: none; padding: 8px 24px; border-radius: 50px; font-weight: 600; font-size: 13px; text-decoration: none; display: inline-block; margin-top: 8px; }
        .claim-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .ads-card { background: var(--gradient); border: none; color: white; padding: 20px 10px; border-radius: 24px; text-align: center; cursor: pointer; position: relative; overflow: hidden; box-shadow: 0 8px 20px rgba(255, 43, 43, 0.4); transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); display: flex; flex-direction: column; justify-content: center; align-items: center; height: 120px; }
        .ads-card:active { transform: scale(0.95); } .ads-card:hover { transform: translateY(-3px); } .ads-card.disabled { background: #2a2a2a; border: 1px solid #333; color: #666; pointer-events: none; opacity: 0.8; box-shadow: none; }
        .ads-icon { font-size: 32px; margin-bottom: 10px; transition: transform 0.5s; } .ads-card:hover .ads-icon { transform: rotate(10deg) scale(1.1); }
        .ads-title { font-size: 14px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; } .ads-reward { font-size: 11px; opacity: 0.9; font-weight: 500; }
        .timer-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; flex-direction: column; justify-content:center; align-items:center; font-size:14px; font-weight:bold; color:white; backdrop-filter: blur(2px); z-index: 5; }
        .stats-box { text-align: center; margin-bottom: 20px; border: 1px solid var(--border); background: var(--card); border-radius: 20px; padding: 25px; position: relative; overflow: hidden; }
        .stats-box::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: var(--gradient); }
        .stats-grid { display: flex; justify-content: space-around; margin-bottom: 20px; }
        .stat-item h3 { font-size: 26px; margin: 0; color: var(--primary); font-weight: 800; }
        .stat-item p { font-size: 11px; margin: 0; color: var(--text-sec); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 5px; }
        .convert-btn { background: var(--text); color: var(--bg); width: 100%; padding: 14px; border-radius: 12px; font-weight: 700; cursor: pointer; border: none; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .convert-btn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }
        .refer-stats-container { background: #2c2c2e; border-radius: 12px; padding: 15px; display: flex; justify-content: space-between; margin-bottom: 15px; border: 1px solid #333; }
        .refer-stat { flex: 1; text-align: center; } .refer-stat:first-child { border-right: 1px solid #444; }
        .refer-title { font-size: 12px; color: #aaaaaa; margin-bottom: 5px; } .refer-val { font-size: 20px; font-weight: bold; color: white; } .refer-val.earnings { color: #ff2b2b; } 
        .lb-item { display: flex; align-items: center; justify-content: space-between; background: var(--input-bg); padding: 12px 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid var(--border); }
        .lb-left { display: flex; align-items: center; gap: 12px; } .lb-img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--border); object-fit: cover; } .lb-rank { font-weight: bold; width: 20px; text-align: center; }
        .lb-name { display: flex; align-items: center; gap: 5px; }
        .rank-1 i { color: #FFD700; font-size: 18px; } .rank-2 i { color: #C0C0C0; font-size: 18px; } .rank-3 i { color: #CD7F32; font-size: 18px; }
        .input-group { position: relative; width: 100%; margin-bottom: 12px; } .input-group input { padding-right: 120px; margin-bottom: 0; }
        .calc-display { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--text-sec); font-size: 13px; font-weight: 600; pointer-events: none; display: none; }
        .popup-btn-container { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        .fee-warning { font-size: 14px; color: var(--text); margin-bottom: 20px; line-height: 1.5; } .fee-btn { width: auto; min-width: 100px; padding: 10px 30px; margin: 0 auto; display: block; }
    </style>
</head>
<body class="dark-mode">

    <div id="loadingScreen">
        <img src="https://i.ibb.co.com/HTYbfgCQ/20260109-193516.png" class="pulse-logo" id="loadingLogo">
    </div>

    <div id="mainApp" style="display:none;">
        <div class="header">
            <div class="user-info">
                <img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" id="headPhoto" class="user-img">
                <div class="user-details">
                    <p class="user-name" id="headName">User</p>
                    <div class="balance-capsule">৳ <span id="headBal">0.00</span></div>
                </div>
            </div>
            <div class="header-actions">
                <i class="fa-solid fa-headset icon-btn" onclick="openSupport()"></i>
            </div>
        </div>

        <div id="home" class="section active">
            <div id="bannerCon" class="banner-container"></div>
            <h3 style="margin-top:15px;">Exclusive Offers</h3>
            <div id="offerCon"></div>
        </div>

        <div id="exchange" class="section">
            <div class="card">
                <h3>Exchange Currency</h3>
                <select id="sendM" class="form-control" onchange="updWallet()"><option value="">Select Method</option></select>
                <div id="walletDiv" style="display:none; background:rgba(255, 43, 43, 0.1); padding:15px; border-radius:12px; margin-bottom:15px; border:1px solid var(--primary);">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px; border-bottom:1px solid rgba(0,0,0,0.1); padding-bottom:8px;">
                        <span style="font-size:12px; color:var(--text-sec);">Rate: <b style="color:var(--text);" id="infoRate">0 BDT</b></span>
                        <span style="font-size:12px; color:var(--text-sec);">Min: <b style="color:var(--text);">$<span id="infoMin">0</span></b></span>
                    </div>
                    <small style="color:var(--primary); font-weight:bold;">Send Address:</small>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
                        <span id="admWallet" style="font-family:monospace; color:var(--text); font-size:13px; word-break: break-all;">...</span>
                        <i class="fa-solid fa-copy" onclick="cp('admWallet')" style="color:var(--primary); cursor:pointer; font-size:16px;"></i>
                    </div>
                </div>
                <div class="input-group">
                    <input type="number" id="exAmt" class="form-control" placeholder="Amount ($)" oninput="calcExchange()">
                    <span class="calc-display" id="calcSpan">= <b id="calcResInside"></b></span>
                </div>
                <input type="text" id="exTrx" class="form-control" placeholder="Trx ID">
                <select id="recM" class="form-control" onchange="checkFeeWarning()">
                    <option value="">Select Wallet</option>
                    <option value="Bkash">Bkash</option>
                    <option value="Nagad">Nagad</option>
                </select>
                <input type="number" id="exNum" class="form-control" placeholder="Your Wallet Number">
                <button class="btn" onclick="reqExchange()">Exchange Now</button>
            </div>
        </div>

        <div id="history" class="section">
            <h3>Activity Log</h3>
            <div id="histList"></div>
        </div>

        <div id="refer" class="section">
            <div class="card">
                <h3>Invite & Earn</h3>
                <p>Invite users! When they exchange, you get <b>1.5% Commission</b> directly to your Main Balance.</p>
                <div class="refer-stats-container">
                    <div class="refer-stat"><div class="refer-title">Total Refer</div><div class="refer-val" id="refCount">0</div></div>
                    <div class="refer-stat"><div class="refer-title">Earnings</div><div class="refer-val earnings">৳ <span id="refEarn">0.00</span></div></div>
                </div>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="refLinkInput" class="form-control" readonly style="margin:0;">
                    <button class="btn" style="width:60px;" onclick="copyRefLink()"><i class="fa-solid fa-copy"></i></button>
                </div>
            </div>
            <h3 style="margin-top:20px; color:var(--text);">Top 20 Leaders</h3>
            <div id="topList" style="padding-bottom:20px;"><p style="text-align:center;">Loading...</p></div>
        </div>

        <div id="earn" class="section">
            <h3 style="margin-bottom:15px; font-weight:800;">Daily Rewards</h3>
            <div class="claim-grid">
                <div class="ads-card" id="dailyBox1" onclick="handleDailyClick(1)">
                    <i class="fa-solid fa-gift ads-icon" style="color:#ffffff;"></i>
                    <span class="ads-title">TASK 1</span>
                    <span class="ads-reward">+50 Points</span>
                    <div class="timer-overlay" id="timer1" style="display:none;"></div>
                </div>
                <div class="ads-card" id="dailyBox2" onclick="handleDailyClick(2)">
                    <i class="fa-solid fa-gift ads-icon"></i>
                    <span class="ads-title">TASK 2</span>
                    <span class="ads-reward">+50 Points</span>
                    <div class="timer-overlay" id="timer2" style="display:none;"></div>
                </div>
            </div>
            <div class="stats-box">
                <div class="stats-grid">
                    <div class="stat-item"><h3 id="earnPoints">0</h3><p>Total Points</p></div>
                    <div class="stat-item"><h3 id="totalClaimCount">0</h3><p>Times Claimed</p></div>
                </div>
                <p style="font-size:12px; color:var(--text-sec); text-align:center; margin-bottom:15px; opacity:0.7;">100,000 Points = 100 BDT</p>
                <button id="btnConvert" class="convert-btn" onclick="convertPoints()" disabled>Need 100,000 Points</button>
            </div>
            <div class="card" style="display:flex; justify-content:space-between; align-items:center; border:1px solid var(--border);">
                <div><b>Withdraw Funds</b><br><small style="color:var(--text-sec);">Main Balance: ৳ <span id="wBalDisplay">0</span></small></div>
                <button class="btn" style="width:auto; padding:10px 25px; margin:0;" onclick="openWithdraw()">Withdraw</button>
            </div>
        </div>

        <div class="nav">
            <div class="nav-item active" onclick="nav('home', this)"><i class="fa-solid fa-house"></i>Home</div>
            <div class="nav-item" onclick="nav('exchange', this)"><i class="fa-solid fa-right-left"></i>Swap</div>
            <div class="nav-item" id="navHistory" onclick="nav('history', this)"><i class="fa-solid fa-clock-rotate-left"></i>History</div>
            <div class="nav-item" onclick="nav('refer', this)"><i class="fa-solid fa-users"></i>Refer</div>
            <div class="nav-item" onclick="nav('earn', this)"><i class="fa-solid fa-gift"></i>Earn</div>
        </div>

        <div id="joinPopup" class="popup">
            <div class="popup-content">
                <i class="fa-brands fa-telegram" style="font-size:40px; color:var(--primary); margin-bottom:15px;"></i>
                <h3>Join Community</h3>
                <p>You must join our official channel to use this bot.</p>
                <div class="popup-btn-container">
                    <button class="btn" onclick="openChannel()">Join Channel</button>
                    <button class="btn" id="verifyBtn" style="background:var(--input-bg); color:var(--text); border:1px solid var(--border);" onclick="manualVerify()">I Joined</button>
                </div>
                <p id="verifyMsg" style="font-size:12px; margin-top:10px; color:red; display:none;"></p>
            </div>
        </div>

        <div id="wPopup" class="popup">
            <div class="popup-content">
                <span class="close-pop" onclick="closePop('wPopup')">&times;</span>
                <h3>Withdraw Money</h3>
                <div id="wFormDiv">
                    <p>Available: <b style="color:var(--primary);" id="wPopBal">0</b> ৳</p>
                    <input type="number" id="wAmount" class="form-control" placeholder="Amount">
                    <select id="wMethod" class="form-control">
                        <option value="">Select Method</option>
                        <option value="Bkash">Bkash</option>
                        <option value="Nagad">Nagad</option>
                        <option value="Binance">Binance</option>
                    </select>
                    <input type="number" id="wNumber" class="form-control" placeholder="Wallet Number">
                    <button class="btn" onclick="submitWithdraw()">Confirm Withdraw</button>
                </div>
                <div id="wOffMsg" style="display:none; color:red; margin-top:10px;"></div>
            </div>
        </div>

        <div id="feePopup" class="popup" style="z-index: 1001;">
            <div class="popup-content">
                <i class="fa-solid fa-circle-info" style="font-size:40px; color:var(--primary); margin-bottom:15px;"></i>
                <h3 style="margin-top:0;">Fee Notice</h3>
                <p class="fee-warning" id="feeText">...</p>
                <button class="btn fee-btn" onclick="closePop('feePopup')">Ok</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, onSnapshot, query, where, orderBy, increment, serverTimestamp, limit } 
        from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

        const BACKEND_URL = "https://dollar-bot-server.onrender.com"; 

        const firebaseConfig = {
          apiKey: "AIzaSyDYUGAUdAg6_6-vacGnQfZ2tyXBC1vHYTA",
          authDomain: "redoexchange-bbac4.firebaseapp.com",
          projectId: "redoexchange-bbac4",
          storageBucket: "redoexchange-bbac4.firebasestorage.app",
          messagingSenderId: "419809399280",
          appId: "1:419809399280:web:f618f5ea28b810d905cd35"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const tg = window.Telegram.WebApp;
        tg.expand();

        let settings = null, methods = {}, isMember = false;
        let minConvert = 100000;
        let minWithdraw = 10;
        let timer1Int, timer2Int;
        let userData = {};
        const user = tg.initDataUnsafe.user || { id: "112233", first_name: "Guest", username: "guest" };
        const uid = user.id.toString();

        function loadAdScripts(monetagId, gigapubId) {
            const oldM = document.getElementById('monetag-script');
            const oldG = document.getElementById('gigapub-script');
            if(oldM) oldM.remove();
            if(oldG) oldG.remove();

            if(monetagId) {
                const s1 = document.createElement('script');
                s1.id = 'monetag-script';
                s1.src = '//libtl.com/sdk.js';
                s1.setAttribute('data-zone', monetagId);
                s1.setAttribute('data-sdk', `show_${monetagId}`);
                document.head.appendChild(s1);
            }

            if(gigapubId) {
                const s2 = document.createElement('script');
                s2.id = 'gigapub-script';
                s2.src = `https://ad.gigapub.tech/script?id=${gigapubId}`;
                document.head.appendChild(s2);
            }
        }

        async function init() {
            onAuthStateChanged(auth, async (u) => {
                if (u) {
                    console.log("Authenticated");
                    startDataListeners();
                } else {
                    console.log("Signing in...");
                    try {
                        await signInAnonymously(auth);
                    } catch (e) {
                        console.error(e);
                        console.log("Auth Error");
                    }
                }
            });
        }

        function startDataListeners() {
            onSnapshot(doc(db, "settings", "appConfig"), async (s) => { 
                if(s.exists()) {
                    settings = s.data();
                    if(settings.loadingImage) document.getElementById('loadingLogo').src = settings.loadingImage;
                    document.getElementById('refLinkInput').value = `https://t.me/${settings.botUsername}?startapp=${uid}`;
                    
                    minConvert = settings.minPointConvert || 100000;
                    minWithdraw = settings.minWithdrawAmount || 10;
                    
                    loadAdScripts(settings.monetagZoneId, settings.gigapubId);

                    document.getElementById('wAmount').placeholder = `Amount (Min ${minWithdraw} ৳)`;

                    verifyJoin(true); 
                    setTimeout(() => { document.getElementById('loadingScreen').style.opacity='0'; setTimeout(()=>{ document.getElementById('loadingScreen').style.display='none'; document.getElementById('mainApp').style.display='block'; }, 500); }, 1500); 
                } 
            });

            onSnapshot(collection(db, "exchange_methods"), s => {
                const sel = document.getElementById('sendM'); sel.innerHTML = `<option value="">Select Method</option>`;
                methods = {};
                s.forEach(d => { 
                    const data = d.data();
                    methods[data.name] = { wallet: data.wallet, rate: data.rate || 0, min: data.min || 5 }; 
                    sel.innerHTML += `<option value="${data.name}">${data.name}</option>`; 
                });
            });

            checkUser();
            
            onSnapshot(collection(db, "banners"), s => {
                const bC = document.getElementById('bannerCon'); bC.innerHTML = "";
                s.forEach(d => bC.innerHTML += `<div class="banner-slide"><img src="${d.data().image}" onclick="window.open('${d.data().link}','_blank')"></div>`);
                startBannerSlide();
            });

            onSnapshot(collection(db, "offers"), s => {
                const oC = document.getElementById('offerCon'); oC.innerHTML = "";
                s.forEach(d => {
                    const o = d.data();
                    oC.innerHTML += `<div class="card" style="display:flex; gap:15px; align-items:center;"><img src="${o.image}" width="50" height="50" style="border-radius:12px; object-fit:cover;"><div style="flex:1;"><b style="font-size:15px;">${o.title}</b><br><a href="${o.link}" class="offer-btn" target="_blank">Visit Offer</a></div></div>`;
                });
            });

            // TOP 20 LISTENER
            const qUsers = query(collection(db, "users"), orderBy("referrals", "desc"), limit(20));
            onSnapshot(qUsers, (s) => {
                const l = document.getElementById('topList'); l.innerHTML = "";
                let i = 1;
                s.forEach(d => {
                    const u = d.data();
                    let rankIcon = i;
                    if(i === 1) rankIcon = '<i class="fa-solid fa-trophy rank-1"></i>';
                    else if(i === 2) rankIcon = '<i class="fa-solid fa-medal rank-2"></i>';
                    else if(i === 3) rankIcon = '<i class="fa-solid fa-medal rank-3"></i>';
                    let uName = u.name.substring(0,15);
                    if((u.referrals || 0) >= 100) uName += ` <span class="verified-badge" style="width:12px; height:12px; font-size:8px;"><i class="fa-solid fa-check"></i></span>`;
                    l.innerHTML += `<div class="lb-item"><div class="lb-left"><div class="lb-rank">${rankIcon}</div><img src="${u.photo||'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" class="lb-img"><div class="lb-info"><span class="lb-name">${uName}</span></div></div><span class="lb-refs">${u.referrals || 0} Ref</span></div>`;
                    i++;
                });
            }, (error) => {
                console.log("Leaderboard Index Error:", error);
                document.getElementById('topList').innerHTML = "<p style='text-align:center;'>Setup required. Check Console.</p>";
            });

            // HISTORY LISTENER (FIXED - NO INDEX REQUIRED)
            const qHistory = query(collection(db, "requests"), where("userId", "==", uid));
            
            onSnapshot(qHistory, (s) => {
                const h = document.getElementById('histList'); 
                h.innerHTML = "";
                
                if(s.empty) {
                    h.innerHTML = "<p style='text-align:center; color:var(--text-sec);'>No history found</p>";
                } else {
                    let historyArray = [];
                    s.forEach(d => {
                        historyArray.push({ id: d.id, ...d.data() });
                    });

                    // Sort by Date Descending using JavaScript
                    historyArray.sort((a, b) => {
                        const dateA = a.date ? a.date.seconds : 0;
                        const dateB = b.date ? b.date.seconds : 0;
                        return dateB - dateA; 
                    });

                    historyArray.forEach(r => {
                        let col = r.status==='Approved'?'green': r.status==='Rejected'?'red':'orange';
                        let txt = r.type==="Exchange" ? `${r.sendMethod} -> ${r.receiveMethod}` : `Withdraw: ${r.method}`;
                        let amt = r.type==="Exchange" ? `$${r.amount}` : `৳${r.amount}`;
                        
                        h.innerHTML += `
                        <div class="card" style="padding:15px; display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <b style="color:var(--primary);">${r.type}</b>
                                <br><small style="color:var(--text-sec);">${txt}</small>
                                <br><b style="font-size:14px;">${amt}</b>
                            </div>
                            <div style="text-align:right;">
                                <span style="color:${col}; font-weight:bold; font-size:12px; border:1px solid ${col}; padding:3px 8px; border-radius:10px;">${r.status}</span>
                                <br><small style="font-size:10px; color:#666;">${r.date ? new Date(r.date.seconds * 1000).toLocaleDateString() : ''}</small>
                            </div>
                        </div>`;
                    });
                }
            }, (error) => {
                console.log("History Error:", error);
            });
        }

        async function checkUser() {
            const uRef = doc(db, "users", uid);
            const snap = await getDoc(uRef);
            
            if (!snap.exists()) {
                const startParam = tg.initDataUnsafe.start_param; 
                let referrer = null;
                if(startParam && startParam.toString() !== uid) {
                    referrer = startParam.toString();
                }
                
                await setDoc(uRef, { 
                    name: user.first_name, username: user.username||"", 
                    balance: 0, mainBalance: 0, photo: user.photo_url||"", 
                    joined: serverTimestamp(), referrals: 0, refEarnings: 0,
                    referredBy: referrer, lastClaim1: null, lastClaim2: null, totalClaims: 0
                });

                if(referrer) { 
                    try { 
                        await updateDoc(doc(db, "users", referrer), { referrals: increment(1) });
                        fetch(`${BACKEND_URL}/api/notify-refer-join`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                referrerId: referrer,
                                newUserName: user.username ? `@${user.username}` : user.first_name
                            })
                        }).catch(e => console.log("Ref notify error", e));

                    } catch(e){ console.log("Referral error:", e); } 
                }
            }
            
            onSnapshot(uRef, s => {
                userData = s.data();
                
                let nameHtml = userData.name;
                if((userData.referrals || 0) >= 100) {
                    nameHtml += ` <span class="verified-badge"><i class="fa-solid fa-check"></i></span>`;
                }
                document.getElementById('headName').innerHTML = nameHtml;
                
                document.getElementById('headBal').innerText = (userData.mainBalance || 0).toFixed(2);
                document.getElementById('wPopBal').innerText = (userData.mainBalance || 0).toFixed(2);
                document.getElementById('wBalDisplay').innerText = (userData.mainBalance || 0).toFixed(2);
                document.getElementById('earnPoints').innerText = (userData.balance || 0);
                document.getElementById('totalClaimCount').innerText = (userData.totalClaims || 0);
                
                if(userData.photo) document.getElementById('headPhoto').src = userData.photo;
                document.getElementById('refCount').innerText = userData.referrals || 0;
                document.getElementById('refEarn').innerText = (userData.refEarnings || 0).toFixed(2);

                checkDailyTimers(userData);
                checkConvertButton(userData.balance);
            });
        }

        function checkConvertButton(points) {
            const btn = document.getElementById('btnConvert');
            if(points >= minConvert) {
                btn.disabled = false;
                btn.innerText = "Convert to Main Balance";
            } else {
                btn.disabled = true;
                btn.innerText = `Need ${minConvert} Points`;
            }
        }

        window.convertPoints = async () => {
            if(userData.balance < minConvert) return; 
            if(!confirm(`Convert ${minConvert} Points?`)) return;
            try {
                const moneyToAdd = (minConvert / 1000); 
                await updateDoc(doc(db, "users", uid), { balance: increment(-minConvert), mainBalance: increment(moneyToAdd) });
                alert(`Success! ${moneyToAdd} BDT added.`);
            } catch(e) { alert("Error"); }
        };

        let slideInterval;
        function startBannerSlide() {
            if(slideInterval) clearInterval(slideInterval);
            const con = document.getElementById('bannerCon');
            slideInterval = setInterval(() => {
                if(con.scrollLeft + con.clientWidth >= con.scrollWidth - 10) con.scrollTo({left: 0, behavior: 'smooth'});
                else con.scrollBy({left: con.clientWidth, behavior: 'smooth'});
            }, 3000);
        }

        function checkDailyTimers(d) {
            updateTimerUI(1, d.lastClaim1);
            updateTimerUI(2, d.lastClaim2);
        }

        function updateTimerUI(id, lastClaimTimestamp) {
            const box = document.getElementById(`dailyBox${id}`);
            const overlay = document.getElementById(`timer${id}`);
            
            if(id === 1 && timer1Int) clearInterval(timer1Int);
            if(id === 2 && timer2Int) clearInterval(timer2Int);

            const last = lastClaimTimestamp ? lastClaimTimestamp.toDate() : new Date(0);
            const now = new Date();
            const isToday = now.toDateString() === last.toDateString();

            if(isToday) {
                box.classList.add('disabled');
                overlay.style.display = 'flex';
                const updateT = () => {
                    const curr = new Date();
                    const midnight = new Date();
                    midnight.setHours(24,0,0,0);
                    const diff = midnight - curr;
                    if(diff <= 0) { 
                        box.classList.remove('disabled');
                        overlay.style.display = 'none';
                        if(id===1) clearInterval(timer1Int); else clearInterval(timer2Int);
                        return;
                    }
                    const h = Math.floor((diff/(1000*60*60)));
                    const m = Math.floor((diff%(1000*60*60))/(1000*60));
                    overlay.innerHTML = `<i class="fa-solid fa-clock timer-icon"></i>${h}h ${m}m`;
                };
                updateT();
                if(id===1) timer1Int = setInterval(updateT, 60000); else timer2Int = setInterval(updateT, 60000);
            } else {
                box.classList.remove('disabled');
                overlay.style.display = 'none';
            }
        }

        window.handleDailyClick = async (type) => {
            if(!isMember) { verifyJoin(false); return; }
            const box = document.getElementById(`dailyBox${type}`);
            if(box.classList.contains('disabled')) return;

            if(type === 1) {
                // MONETAG Logic
                const zoneId = settings.monetagZoneId || '9962231';
                const showFunc = window[`show_${zoneId}`];
                if(typeof showFunc === 'function') {
                    showFunc().then(() => grantReward(1)).catch(() => {
                        setTimeout(() => grantReward(1), 2000);
                    });
                } else {
                    setTimeout(() => grantReward(1), 3000);
                }
            } 
            else if (type === 2) {
                // GIGAPUB Logic - Fixed Direct Link
                if(settings && settings.gigapubDirectLink) {
                    if(tg && tg.openLink) {
                        tg.openLink(settings.gigapubDirectLink);
                    } else {
                        window.open(settings.gigapubDirectLink, '_blank');
                    }
                    // Simulate wait time for ad view
                    setTimeout(() => grantReward(2), 5000);
                } else {
                    alert("Ad link not configured by admin.");
                }
            }
        };

        async function grantReward(type) {
            try {
                let updateData = { 
                    balance: increment(50), 
                    totalClaims: increment(1) 
                };
                if(type === 1) updateData.lastClaim1 = serverTimestamp();
                else updateData.lastClaim2 = serverTimestamp();
                await updateDoc(doc(db, "users", uid), updateData);
                alert(`Success! Received 50 Points.`);
            } catch(e) { console.error(e); }
        }

        window.updWallet = () => { const m = document.getElementById('sendM').value; const div = document.getElementById('walletDiv'); if(methods[m]) { div.style.display = "block"; document.getElementById('admWallet').innerText = methods[m].wallet; document.getElementById('infoRate').innerText = methods[m].rate + " ৳"; document.getElementById('infoMin').innerText = methods[m].min; } else { div.style.display = "none"; } calcExchange(); };
        window.calcExchange = () => { const m = document.getElementById('sendM').value; const amt = parseFloat(document.getElementById('exAmt').value); if(methods[m] && amt > 0) { document.getElementById('calcSpan').style.display = "block"; document.getElementById('calcResInside').innerText = (amt * methods[m].rate).toFixed(2) + "৳"; } else { document.getElementById('calcSpan').style.display = "none"; } };
        window.checkFeeWarning = () => { const recM = document.getElementById('recM').value; if(recM === "Bkash" || recM === "Nagad") { document.getElementById('feeText').innerText = recM === "Bkash" ? "বিকাশের মাধ্যমে Payment গ্রহণ করলে bkash নির্ধারিত ফি প্রযোজ্য হবে" : "নগদ এর মাধ্যমে Payment গ্রহণ করলে Nagad নির্ধারিত ফি প্রযোজ্য হবে"; document.getElementById('feePopup').style.display = "flex"; } };

        window.reqExchange = async () => { 
            if(!isMember) { verifyJoin(false); return; }
            const sendM = document.getElementById('sendM').value; 
            const amt = document.getElementById('exAmt').value; 
            const trx = document.getElementById('exTrx').value; 
            const recM = document.getElementById('recM').value; 
            const num = document.getElementById('exNum').value; 
            
            if(!sendM || !amt || !trx || !recM || !num) return alert("Fill all fields"); 
            if(parseFloat(amt) < methods[sendM].min) return alert(`Min amount is $${methods[sendM].min}`); 
            
            const rate = methods[sendM].rate;
            const bdtAmount = (parseFloat(amt) * rate).toFixed(2);
            
            await addDoc(collection(db, "requests"), { 
                userId: uid, 
                userName: user.first_name, 
                userPhoto: userData.photo||"", 
                type: "Exchange", 
                sendMethod: sendM, 
                amount: parseFloat(amt), 
                bdtAmount: bdtAmount, 
                trxId: trx, 
                receiveMethod: recM, 
                userNumber: num, 
                referrerId: userData.referredBy||null, 
                status: "Pending", 
                date: serverTimestamp() 
            }); 
            
            fetch(`${BACKEND_URL}/api/notify-exchange`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    username: user.username ? `@${user.username}` : user.first_name,
                    chatId: uid,
                    sendMethod: sendM,
                    recMethod: recM,
                    number: num,
                    trx: trx,
                    amount: amt,
                    bdtAmount: bdtAmount
                })
            }).catch(e => console.log("Notify Error", e));

            alert("Submitted!"); 
            
            document.getElementById('sendM').value = "";
            document.getElementById('exAmt').value = "";
            document.getElementById('exTrx').value = "";
            document.getElementById('recM').value = "";
            document.getElementById('exNum').value = "";
            document.getElementById('walletDiv').style.display = "none";
            document.getElementById('calcSpan').style.display = "none";
            
            nav('history', document.getElementById('navHistory')); 
        };

        window.openWithdraw = () => { document.getElementById('wPopup').style.display = 'flex'; if(settings.withdrawStatus) { document.getElementById('wFormDiv').style.display='block'; document.getElementById('wOffMsg').style.display='none'; } else { document.getElementById('wFormDiv').style.display='none'; document.getElementById('wOffMsg').style.display='block'; document.getElementById('wOffMsg').innerText = settings.withdrawNotice || "Closed"; } };
        window.closePop = (id) => document.getElementById(id).style.display='none';
        
        window.submitWithdraw = async () => { 
            const amount = document.getElementById('wAmount').value; 
            const meth = document.getElementById('wMethod').value; 
            const num = document.getElementById('wNumber').value; 
            
            if(!amount || !meth || !num) return alert("Fill all fields"); 
            if(parseFloat(amount) < minWithdraw) return alert("Min Withdraw " + minWithdraw + " ৳"); 
            
            if(parseFloat(amount) > (userData.mainBalance || 0)) {
                return alert("Insufficient Balance");
            }
            
            await updateDoc(doc(db, "users", uid), { mainBalance: increment(-parseFloat(amount)) }); 
            
            await addDoc(collection(db, "requests"), { 
                userId: uid, 
                userName: user.first_name, 
                userPhoto: userData.photo||"", 
                totalReferrals: userData.referrals||0, 
                currentMainBalance: (userData.mainBalance-parseFloat(amount)), 
                type: "Withdraw", 
                amount: parseFloat(amount), 
                method: meth, 
                userNumber: num, 
                status: "Pending", 
                date: serverTimestamp() 
            }); 
            
            alert("Withdraw Submitted! Balance deducted."); 
            closePop('wPopup'); 
            nav('history', document.getElementById('navHistory')); 
        };

        window.nav = (n, e) => { if(!isMember && n !== 'home') { verifyJoin(false); return; } document.querySelectorAll('.section').forEach(x=>x.classList.remove('active')); document.getElementById(n).classList.add('active'); document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); e.classList.add('active'); };
        
        window.manualVerify = () => verifyJoin(false, true); 
        window.verifyJoin = async (silent = false, isManual = false) => { 
            if(!settings || !settings.requiredChannel) { 
                isMember=true; 
                document.getElementById('joinPopup').style.display='none'; 
                return; 
            } 
            if(isManual) {
                const btn = document.getElementById('verifyBtn');
                btn.innerText = "Connecting...";
                btn.disabled = true;
            }

            try { 
                const res = await fetch(`${BACKEND_URL}/api/verify-member`, { 
                    method:'POST', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({userId:uid, channelUsername:settings.requiredChannel}) 
                }); 
                const data = await res.json(); 
                
                if(data.isMember) { 
                    isMember=true; 
                    document.getElementById('joinPopup').style.display='none'; 
                    if(isManual) {
                        document.getElementById('verifyBtn').innerText = "I Joined";
                        document.getElementById('verifyBtn').disabled = false;
                    }
                } else { 
                    isMember=false; 
                    if(!silent) document.getElementById('joinPopup').style.display='flex'; 
                    if(isManual) { 
                        document.getElementById('verifyBtn').innerText = "Try Again"; 
                        document.getElementById('verifyBtn').disabled = false;
                        document.getElementById('verifyMsg').style.display = 'block'; 
                        document.getElementById('verifyMsg').innerText = "Not joined yet!"; 
                    } 
                } 
            } catch(e) { 
                if(isManual) {
                    document.getElementById('verifyBtn').innerText = "Try Again";
                    document.getElementById('verifyBtn').disabled = false;
                }
            } 
        };
        window.openChannel = () => window.open(`https://t.me/${settings.requiredChannel.replace('@','')}`, '_blank'); window.openSupport = () => window.open(settings.supportLink, '_blank'); window.cp = (id) => { navigator.clipboard.writeText(document.getElementById(id).innerText); alert("Copied"); }; window.copyRefLink = () => { navigator.clipboard.writeText(document.getElementById('refLinkInput').value); alert("Copied"); };
        
        init();
    </script>
</body>
</html>
